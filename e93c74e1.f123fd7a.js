(window.webpackJsonp=window.webpackJsonp||[]).push([[543],{615:function(e,t,n){"use strict";n.r(t),n.d(t,"frontMatter",(function(){return s})),n.d(t,"metadata",(function(){return i})),n.d(t,"rightToc",(function(){return l})),n.d(t,"default",(function(){return p}));var r=n(3),a=n(8),o=(n(0),n(682)),s={title:"Running the Trustlines system"},i={unversionedId:"tutorials/trustlines_system",id:"version-0.20.1/tutorials/trustlines_system",isDocsHomePage:!1,title:"Running the Trustlines system",description:"This document explains how to run your own trustlines network relay server infrastructure. We will walk you through setting up a relay server and all dependent components. The current documentation is written for a Debian-based Linux system.",source:"@site/relay_versioned_docs/version-0.20.1/tutorials/trustlines_system.md",slug:"/tutorials/trustlines_system",permalink:"/relay/tutorials/trustlines_system",editUrl:"https://github.com/trustlines-protocol/tl-dev-docs/edit/master/relay_versioned_docs/version-0.20.1/tutorials/trustlines_system.md",version:"0.20.1",sidebar:"version-0.20.1/Relay",previous:{title:"Release",permalink:"/relay/develop/release"},next:{title:"Trustlines Network Rest API",permalink:"/relay/api/introduction"}},l=[{value:"Dependencies",id:"dependencies",children:[{value:"Trustlines Blockchain",id:"trustlines-blockchain",children:[]},{value:"Contracts",id:"contracts",children:[]},{value:"PostgreSQL",id:"postgresql",children:[]},{value:"Creating a virtualenv",id:"creating-a-virtualenv",children:[]},{value:"Py-eth-index",id:"py-eth-index",children:[]},{value:"Relay server",id:"relay-server",children:[]}]}],c={rightToc:l};function p(e){var t=e.components,n=Object(a.a)(e,["components"]);return Object(o.b)("wrapper",Object(r.a)({},c,n,{components:t,mdxType:"MDXLayout"}),Object(o.b)("p",null,"This document explains how to run your own ",Object(o.b)("a",Object(r.a)({parentName:"p"},{href:"https://trustlines.network/"}),"trustlines network")," relay server infrastructure. We will walk you through setting up a relay server and all dependent components. The current documentation is written for a Debian-based Linux system."),Object(o.b)("p",null,"If you are low on time, you may jump to the description of the ",Object(o.b)("a",Object(r.a)({parentName:"p"},{href:"/relay/getting_started/docker"}),"docker-compose based setup"),"."),Object(o.b)("h2",{id:"dependencies"},"Dependencies"),Object(o.b)("p",null,"Since the trustlines infrastructure components are implemented in python 3, you need to install relevant dependencies. You will need at least python 3.6."),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{}),"sudo apt install build-essential python3-dev python3-venv pkg-config git libpq-dev\n")),Object(o.b)("p",null,"The installation instructions assume you create a dedicated user account and put\nfiles directly into the user's home directory. Else, adapt the paths to your needs!"),Object(o.b)("h3",{id:"trustlines-blockchain"},"Trustlines Blockchain"),Object(o.b)("p",null,"You need to run our modified OpenEthereum node, which provides the JSONRPC API to the relay\nserver and the indexer. The documentation on how to run it can be found ",Object(o.b)("a",Object(r.a)({parentName:"p"},{href:"/blockchain/tlbc"}),"here"),"."),Object(o.b)("h3",{id:"contracts"},"Contracts"),Object(o.b)("p",null,"The ",Object(o.b)("a",Object(r.a)({parentName:"p"},{href:"https://github.com/trustlines-protocol/contracts"}),"trustlines-contracts\nrepository")," contains the\nsolidity contracts to be deployed on the blockchain and a commandline tool to deploy the contracts. The\n",Object(o.b)("a",Object(r.a)({parentName:"p"},{href:"/contracts/deploy_tools/introduction"}),"deploy tools section")," in the contracts docs contains more information on how to deploy the contracts.\nThe tool will return the addresses of the deployed contracts. You need to provide that information to the relay server with as json file ",Object(o.b)("inlineCode",{parentName:"p"},"addresses.json")," with the following format:"),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{}),'{\n  "networks":\n  [<list of currency network addresses>],\n}\n')),Object(o.b)("p",null,"The directory called ",Object(o.b)("inlineCode",{parentName:"p"},"config/")," contains already prepared files for the different\nnetworks of the foundation. Those include a list of addresses for the registered\ncurrency networks. You can copy one of those files and adopt it to your needs,\nin case you want to add custom deployed networks."),Object(o.b)("p",null,"We assume from now on that the contracts have already been deployed\nand that the ",Object(o.b)("inlineCode",{parentName:"p"},"addresses.json")," file has been copied to the user's home directory."),Object(o.b)("h3",{id:"postgresql"},"PostgreSQL"),Object(o.b)("p",null,"The trustlines system uses a PostgreSQL database to store some user data and to\nkeep a synchronized view on the relevant state from the blockchain."),Object(o.b)("p",null,"Install PostgreSQL with:"),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{}),"sudo apt install postgresql\n")),Object(o.b)("p",null,"After this, a database user must be created. Please use a real password:"),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{}),"sudo -u postgres psql <<EOF\nCREATE USER trustlines WITH PASSWORD 'choose-a-password-here';\nALTER USER trustlines CREATEDB;\nEOF\n")),Object(o.b)("p",null,"Next, the postgres environment should be configured for the account running\nthe relay server:"),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{}),"echo >>~/.pgpass 'localhost:5432:*:trustlines:choose-a-password-here'; chmod 0600 ~/.pgpass\ncat >>~/.bashrc <<EOF\nexport PGUSER=trustlines\nexport PGHOST=localhost\nexport PGDATABASE=trustlinesdb\nEOF\n")),Object(o.b)("p",null,"After logging in again, in order to have the environment variables set, the user\nshould be able to create the database:"),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{}),"createdb trustlinesdb\n")),Object(o.b)("p",null,"The rest of this tutorial assumes that the user running the relay and\npy-eth-index related commands has a working postgresql environment\nconfigured.  All programs consider the ",Object(o.b)("inlineCode",{parentName:"p"},"PG*")," environment variables\n(like ",Object(o.b)("inlineCode",{parentName:"p"},"PGHOST"),", ",Object(o.b)("inlineCode",{parentName:"p"},"PGUSER"),", ...) and will read ",Object(o.b)("inlineCode",{parentName:"p"},"~/.pgpass")," for\ninformation about passwords. The ",Object(o.b)("a",Object(r.a)({parentName:"p"},{href:"#py-eth-index"}),"py-eth-index section"),"\ndescribes how to create the trustlines specific tables."),Object(o.b)("h3",{id:"creating-a-virtualenv"},"Creating a virtualenv"),Object(o.b)("p",null,"Run the following command to create a virtualenv:"),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{}),"mkdir -p ~/opt\npython3 -mvenv ~/opt/trustlines-system\n~/opt/trustlines-system/bin/pip install -U pip wheel setuptools\n")),Object(o.b)("p",null,"And activate the virtualenv with"),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{}),"source ~/opt/trustlines-system/bin/activate\n")),Object(o.b)("p",null,"This will add ~/opt/trustlines-system/bin to ",Object(o.b)("inlineCode",{parentName:"p"},"PATH"),". The following\nsteps assumes an acticated virtualenv."),Object(o.b)("h3",{id:"py-eth-index"},"Py-eth-index"),Object(o.b)("p",null,"The ",Object(o.b)("a",Object(r.a)({parentName:"p"},{href:"https://github.com/trustlines-protocol/py-eth-index"}),"py-eth-index repository"),"\ncontains a helper program that synchronizes the relevant information from the\nblockchain into a postgresql database."),Object(o.b)("h4",{id:"installation-of-py-eth-index"},"Installation of py-eth-index"),Object(o.b)("p",null,"Clone the git repository:"),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{}),"cd ~\ngit clone https://github.com/trustlines-protocol/py-eth-index\n")),Object(o.b)("p",null,"And install py-eth-index"),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{}),"cd ~/py-eth-index\npip install -c constraints.txt .\n")),Object(o.b)("h4",{id:"initializing-the-database"},"Initializing the database"),Object(o.b)("p",null,"After the database has been created, it must be initialized. This can be done with the following command:"),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{}),"ethindex createtables\n")),Object(o.b)("h4",{id:"importing-the-abis"},"Importing the ABIs"),Object(o.b)("p",null,"We need to import the ABIs from the trustline-contracts. Trustlines-contracts is\ninstalled as a dependency of the relay server. Please run the following only\nafter you have installed the relay server."),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{}),"cp ~/opt/trustlines-system/trustlines-contracts/build/contracts.json ~\n~/opt/py-eth-index/bin/ethindex importabi\n")),Object(o.b)("p",null,"If you did not follow this document to install the relay but prefer an\nalternative approach (like via\n",Object(o.b)("a",Object(r.a)({parentName:"p"},{href:"/relay/getting_started/docker"}),"docker-compose"),"), checkout ",Object(o.b)("a",Object(r.a)({parentName:"p"},{href:"#get-contract-abis"}),"this\nsection")," about the different options to retrieve the\n",Object(o.b)("inlineCode",{parentName:"p"},"contracts.json")," file."),Object(o.b)("h4",{id:"importing-events"},"Importing events"),Object(o.b)("p",null,"The following command will start importing all relevant events into the postgres\ndatabase:"),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{}),"ethindex runsync\n")),Object(o.b)("p",null,"This program will run forever."),Object(o.b)("h3",{id:"relay-server"},"Relay server"),Object(o.b)("h4",{id:"installation-of-the-relay-server"},"Installation of the relay server"),Object(o.b)("p",null,"Clone the git repository and install it:"),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{}),"cd ~\ngit clone https://github.com/trustlines-protocol/relay\ncd ~/relay\npip install -r requirements.txt .\n")),Object(o.b)("h4",{id:"running-the-relay-server"},"Running the relay server"),Object(o.b)("p",null,"The relay server needs the addresses of the deployed contracts. In case you've\ndeployed your own contracts, please copy addresses.json to ",Object(o.b)("inlineCode",{parentName:"p"},"~"),"."),Object(o.b)("p",null,"We will also need a config file. You can use the one from the git checkout:"),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{}),"cp ~/relay/config.toml ~\n")),Object(o.b)("p",null,"The relay server reads both files from the current directory per default,\nso we need to start it where those files have been copied to:"),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{}),"cd ~\ntl-relay\n")),Object(o.b)("p",null,"However, this behaviour can be changed, you can check the options with:"),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{}),"tl-relay --help\n")),Object(o.b)("p",null,"The relay server needs access to the OpenEthereum node and the PostgreSQL database.\n",Object(o.b)("inlineCode",{parentName:"p"},"ethindex runsync")," also has to be running for a fully functioning system."),Object(o.b)("h4",{id:"signing-transactions"},"Signing Transactions"),Object(o.b)("p",null,"The relay server needs to sign transactions. The default behaviour is\nto rely on a OpenEthereum node with an unlocked account, that signs\ntransactions."),Object(o.b)("p",null,"Alternatively the relay can sign transactions locally itself with a\nconfigured key. For this approach add the following section to the\nconfiguration file and adjust the values. The key is expected to be\nencrypted in a keystore file. To unlock the key, a password file in\nclear text must be provided as well."),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{className:"language-toml"}),'[account]\nkeystore_path = "keystore.json"\nkeystore_password_path = "keystore-password.txt"\n')),Object(o.b)("h4",{id:"get-contract-abis"},"Get Contract ABIs"),Object(o.b)("p",null,"The file with the compiled contracts (",Object(o.b)("inlineCode",{parentName:"p"},"contracts.json"),") is bundled within\nmultiple packages on different platforms. Please checkout that approach that\nfits the best for your setup from list below."),Object(o.b)("h5",{id:"pypi"},"PyPI"),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{className:"language-bash"}),"pip download trustlines-contracts-bin --dest /tmp && tar --extract --file /tmp/trustlines-contracts-bin*.tar.gz --no-anchored 'contracts.json' --strip-components 1\n")),Object(o.b)("p",null,"To download a specific version, add the version directly behind the package name\nseparated with a ",Object(o.b)("inlineCode",{parentName:"p"},"==")," (e.g. ",Object(o.b)("inlineCode",{parentName:"p"},"trustlines-contracts-bin==1.1.2"),")."),Object(o.b)("h5",{id:"npm"},"NPM"),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{className:"language-bash"}),"curl -L $(npm view trustlines-contracts-abi dist.tarball) | tar --extract --gzip --no-anchored 'contracts.json' --strip-components 1\n")),Object(o.b)("p",null,"To download a specific version, add the version directly behind the package name\nseparated with a ",Object(o.b)("inlineCode",{parentName:"p"},"@")," (e.g. ",Object(o.b)("inlineCode",{parentName:"p"},"trustlines-contracts-abi@1.1.2"),")."),Object(o.b)("h5",{id:"dockerhub"},"DockerHub"),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{className:"language-bash"}),'docker run --rm --volume $(pwd):/here --entrypoint /bin/bash trustlines/relay -c "cp /opt/relay/trustlines-contracts/build/contracts.json /here"\n')),Object(o.b)("p",null,"To download a specific version in relation of the relay, add the wished image\ntag behind the image name (e.g. ",Object(o.b)("inlineCode",{parentName:"p"},"trustlines/relay:0.12.1"),")."))}p.isMDXComponent=!0},682:function(e,t,n){"use strict";n.d(t,"a",(function(){return b})),n.d(t,"b",(function(){return h}));var r=n(0),a=n.n(r);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function s(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?s(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):s(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},o=Object.keys(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var c=a.a.createContext({}),p=function(e){var t=a.a.useContext(c),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},b=function(e){var t=p(e.components);return a.a.createElement(c.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return a.a.createElement(a.a.Fragment,{},t)}},u=a.a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,s=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),b=p(n),u=r,h=b["".concat(s,".").concat(u)]||b[u]||d[u]||o;return n?a.a.createElement(h,i(i({ref:t},c),{},{components:n})):a.a.createElement(h,i({ref:t},c))}));function h(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,s=new Array(o);s[0]=u;var i={};for(var l in t)hasOwnProperty.call(t,l)&&(i[l]=t[l]);i.originalType=e,i.mdxType="string"==typeof e?e:r,s[1]=i;for(var c=2;c<o;c++)s[c]=n[c];return a.a.createElement.apply(null,s)}return a.a.createElement.apply(null,n)}u.displayName="MDXCreateElement"}}]);